var cp,stage,s,args;function import$(e,t){var s,i={}.hasOwnProperty;for(s in t)i.call(t,s)&&(e[s]=t[s]);return e}function in$(e,t){for(var s=-1,i=t.length>>>0;++s<i;)if(e===t[s])return!0;return!1}cp=function(e){return JSON.parse(JSON.stringify(e))},stage=function(){return this.data={},this.dim={},this.mapsets={list:[]},this.user={item:[]},this.cursor={key:"c"},this.lv=0,this.ldcv={},this.snd={},this.mode="intro",this},stage.dim={size:32,vp:12},stage.tileinfo={a:{name:"void",through:!0,over:!1,fill:!0,push:!0},b:{name:"bedrock",through:!1,over:!0,fill:!1,push:!1},c:{name:"earth",through:!1,over:!0,fill:!1,push:!1},d:{name:"wall",through:!1,over:!0,fill:!1,push:!1},e:{name:"stool",through:!1,over:!0,fill:!1,push:!1},f:{name:"grass",through:!1,over:!1,fill:!0,push:!1},g:{name:"door",through:!0,over:!1,fill:!1,push:!1},h:{name:"key",through:!0,over:!1,fill:!1,push:!1},i:{name:"exit",through:!0,over:!1,fill:!1,push:!1},j:{name:"stair",through:!0,over:!1,fill:!1,push:!1},k:{name:"gravel",through:!0,over:!1,fill:!1,push:!1},l:{name:"sapphire",through:!0,over:!1,fill:!1,push:!1,score:10},m:{name:"button",through:!0,over:!1,fill:!1,push:!1},n:{name:"button-pressed",through:!0,over:!1,fill:!0,push:!1},o:{name:"trapwall",through:!0,over:!1,fill:!0,push:!1},p:{name:"trapdoor",through:!1,over:!0,fill:!1,push:!1},q:{name:"amethyst",through:!0,over:!1,fill:!1,push:!1,score:250},r:{name:"topaz",through:!0,over:!1,fill:!1,push:!1,score:1250},s:{name:"emerald",through:!0,over:!1,fill:!1,push:!1,score:50},t:{name:"spike",through:!1,over:!1,fill:!1,push:!1}},stage.prototype=import$(Object.create(Object.prototype),{restart:function(){return this.user.score=this.user.startScore,this.load({lv:this.lv})},reset:function(){return this.user.score=0,this.load({lv:0})},sndPause:function(e){return this.snd[e].pause()},sndPlay:function(e,t){return(t=null==t?{}:t).loop&&(this.snd[e].loop=!0),this.snd[e].currentTime=0,this.snd[e].play()},setMode:function(e){return"edit"===(e=null==e?"edit":e)?(this.editData&&(this.data=cp(this.editData),this.tiles=this.data.tiles,this.users=this.data.users),this.mode="edit",this.sndPause("bgm")):"intro"===e?(this.mode="intro",this.sndPause("bgm")):(import$(this.user,this.data.user),this.mode="play"),this.render()},init:function(){var t,a=this,s=function(e){var t=e.node,s=e.evt,i=t.getBoundingClientRect(),r=[s.touches[0].pageX,s.touches[0].pageY],e=r[0],r=r[1];return e=(e-i.x)/i.width,r=(r-i.y)/i.height,e=Math.abs(e-.5)>Math.abs(r-.5)?.5<e?2:0:.5<r?3:1,(r=a.user).dir===e&&r.moving||(r.lastMoveTime=null),r.dir=e,r.moving=!0,a.el.user.style.backgroundPositionY=1.4964*-stage.dim.size*[2,1,3,0][e]+"px",s.preventDefault(),t.textContent=""};return this.ldld=new ldLoader({class:"ldld full"}),this.ldld.on(),this.view=t=new ldView({initRender:!1,root:document.body,init:{finish:function(e){e=e.node;return a.ldcv.finish=new ldCover({root:e})},picked:function(e){return e.node.appendChild(a.el.sampleTile.cloneNode(!0))}},text:{lv:function(){return null!=a.lv?a.lv+1:"-"},score:function(){return a.user.score||0}},handler:{mapset:{list:function(){var e;return(e=a.mapsets).list||(e.list=[])},key:function(e){return e.name},handler:function(e){var t=e.node,e=e.data;return t.innerText=e.name,t.value=e.id}},"on-mode":function(e){var t=e.node,e=t.getAttribute("data-mode");return t.classList.toggle("d-none",e!==a.mode)},"sample-tile":function(){},field:function(){},user:function(){},cursor:function(){},scene:function(){},lv:function(){},score:function(){},picked:function(e){return e.node.childNodes[0].setAttribute("class",["tile"].concat([stage.tileinfo[a.cursor.key].name]).join(" "))},screen:function(e){var t=e.node,e=t.getAttribute("data-name").split(" ");return t.classList.toggle("d-none",!in$(a.mode,e))}},action:{touchstart:{gamepad:function(e){var t=e.node,e=e.evt;return a.snd.bgm.paused&&"play"===a.mode&&a.sndPlay("bgm",{loop:!0}),s({node:t,evt:e})}},touchmove:{gamepad:function(e){var t=e.node,e=e.evt;return s({node:t,evt:e})}},touchend:{gamepad:function(e){e.node;e=e.evt;return a.user.moving=!1,e.preventDefault()}},click:{start:function(){var e;return a.setMode("play"),e=t.get("selected-mapset").value,ld$.fetch("assets/map/"+e+"/index.json",{method:"GET"},{type:"json"}).then(function(e){return a.mapset=e,a.load({lv:0})})},"go-edit":function(){return a.setMode("edit")},"test-run":function(){return a.editData=cp(a.data),a.setMode("play")},download:function(){var e=URL.createObjectURL(new Blob([JSON.stringify(a.data)],{type:"application/json"})),e=ld$.create({name:"a",attr:{href:e,download:"result.json"}});return document.body.appendChild(e),e.click(),document.body.removeChild(e)},restart:function(){return a.restart()},reset:function(){return a.ldcv.finish.toggle(!1),a.reset()},ext:function(e){var t=+e.node.getAttribute("data-type");return 0==t&&a.tiles.map(function(e){return e.map(function(e){return e.splice(0,0,cp(e[0]))})}),1==t&&a.tiles.map(function(e){return e.splice(0,0,cp(e[0]))}),2==t&&a.tiles.map(function(e){return e.map(function(e){return e.splice(e.length,0,cp(e[e.length-1]))})}),3==t&&a.tiles.map(function(e){return e.splice(e.length,0,cp(e[e.length-1]))}),4==t&&a.tiles.map(function(e){return e.map(function(e){return e.splice(0,1)})}),5==t&&a.tiles.map(function(e){return e.splice(0,1)}),6==t&&a.tiles.map(function(e){return e.map(function(e){return e.splice(e.length-1,1)})}),7==t&&a.tiles.map(function(e){return e.splice(e.length-1,1)}),8==t&&a.tiles.splice(a.tiles.length,0,(e=a.tiles)[e.length-1].map(function(e){return e.map(function(){return"a"})})),9==t&&a.tiles.splice(0,0,cp(a.tiles[0])),10==t&&1<a.tiles.length&&a.tiles.splice(a.tiles.length-1,1),11==t&&1<a.tiles.length&&a.tiles.splice(0,1),a.prepare(),a.render()}}}}),this.el={sampleTile:t.get("sample-tile").cloneNode(!0),scene:t.get("scene"),field:t.get("field"),user:t.get("user"),cursor:t.get("cursor"),picked:t.get("picked")},this.el.sampleTile.classList.remove("d-none"),this.view.render(),this.snd.bgm=new Audio("assets/snd/adventure.mp3"),this.snd.get=new Audio("assets/snd/get.ogg"),this.snd.pass=new Audio("assets/snd/pass.ogg"),this.snd.key=new Audio("assets/snd/key.ogg"),this.snd.push=new Audio("assets/snd/push.ogg"),this.snd.hit=new Audio("assets/snd/hit.ogg"),this.snd.press=new Audio("assets/snd/press.ogg"),requestAnimationFrame(function(e){return a.firekey(e)}),document.addEventListener("keyup",function(e){var t=e.which;if(32===t&&(a.cursor.entering=!1),!(t<37||40<t))return(e=a.user).dir===t-37?e.moving=!1:void 0}),document.addEventListener("keydown",function(e){var t,s,i,r,n=[a.user,e.which],o=n[0],e=n[1];if(a.snd.bgm.paused&&"play"===a.mode&&a.sndPlay("bgm",{loop:!0}),82===e&&"play"===a.mode)return a.restart();if("edit"===a.mode){if(80===e&&((s=a.data.user).x=(n=a.user).x,s.y=n.y,s.f=n.f,a.renderUser()),83!==e&&87!==e||(o.f=0<(s=o.f+(t=83===e?-1:1))?s:0,o.f>=a.dim.f&&(o.f=a.dim.f-1),a.tiles[o.f]||(a.tiles[o.f]=function(){for(var e,t,s,i=[],r=0,n=this.dim.h;r<n;++r){for(e=[],t=0,s=this.dim.w;t<s;++t)e.push("a");i.push(e)}return i}.call(a)),a.render()),65===e||68===e){for(r in i=[],stage.tileinfo)i.push(r);s=i,t=65===e?-1:1,a.cursor.key=s[(s.indexOf(a.cursor.key)+t+s.length)%s.length],a.renderUser()}8===e&&(a.tiles[o.f][o.y][o.x]="a",a.render()),32===e&&(a.cursor.entering=!0,a.tiles[o.f][o.y][o.x]=a.cursor.key,a.render()),70===e&&(a.tiles[o.f].map(function(e){for(var t,s=[],i=0,r=e.length;i<r;++i)t=i,s.push(e[t]=a.cursor.key);return s}),a.render())}return e<37||40<e?void 0:(o.dir===(e=e-37)&&o.moving||(o.lastMoveTime=null),o.dir=e,o.moving=!0,a.el.user.style.backgroundPositionY=1.4964*-stage.dim.size*[2,1,3,0][e]+"px")}),ld$.fetch("assets/map/index.json",{method:"GET"},{type:"json"}).then(function(e){return a.mapsets=e,a.view.render("mapset"),a.ldld.off()})},zIndex:function(e){e.x;var t=e.y,s=e.f,e=e.p;return 2*(s*this.dim.w*this.dim.h+t)+(e?1:0)},renderUser:function(){var e=[stage.dim.size,stage.dim.vp],t=e[0],s=e[1],i=(e=("play"===this.mode?this:this.data).user).x,r=e.y,e=e.f;return import$(this.el.user.style,{left:i*t+"px",top:r*t-e*s+"px",zIndex:this.zIndex({f:e,y:r,x:i,p:1})}),import$(this.el.cursor.style,{left:this.user.x*t+"px",top:this.user.y*t-this.user.f*s+"px",zIndex:this.zIndex({f:this.user.f,y:this.user.y,x:this.user.x,p:1})}),this.el.cursor.style.display="edit"===this.mode?"block":"none",this.view.render("picked")},render:function(){var e,t,s,i,r,n,o,a,u,h,d,l,p,c=[this.dim,this.tiles,stage.tileinfo],f=c[0],m=c[1],g=c[2],v=(c=[stage.dim.size,stage.dim.vp])[0],y=c[1],x=(c=[this.el.sampleTile,this.el.field,this.el.scene])[0],w=c[1];for(import$(c[2].style,{width:f.w*v+"px",height:f.h*v+y+"px"}),w.innerHTML="",this.nodes=[],e=[],t=0,s=f.f;t<s;++t){for(i=t,r=[],n=0,o=f.h;n<o;++n){for(a=n,u=[],h=0,d=f.w;h<d;++h)l=h,p=x.cloneNode(!0),w.appendChild(p),p.classList.add(g[m[i][a][l]].name),import$(p.style,{left:l*v+"px",top:a*v-i*y+"px",zIndex:this.zIndex({f:i,x:l,y:a,p:0})}),u.push(p);r.push(u)}e.push(r)}return this.nodes=e,this.renderUser(),this.view.render()},prepare:function(){return this.tiles=this.data.tiles,import$(this.user,this.data.user),import$(this.dim,{f:this.data.tiles.length,h:this.data.tiles[0].length,w:this.data.tiles[0][0].length})},edit:function(){return this.mode="edit",this.data={user:{x:0,y:0,f:0},tiles:[function(){for(var e,t,s=[],i=0;i<10;++i){for(e=[],t=0;t<10;++t)e.push("a");s.push(e)}return s}()]},this.prepare(),this.render()},load:function(arg$){var lv,path,mode,mapset,p,this$=this,lv=arg$.lv,path=arg$.path,mode=arg$.mode,mapset=arg$.mapset,p=mapset?ld$.fetch("assets/map/"+mapset+"/index.json",{method:"GET"},{type:"json"}).then(function(e){return this$.mapset=e}):Promise.resolve();return p.then(function(){var e;return(e=this$.mapset.list[lv])?(e="assets/map/"+this$.mapset.id+"/"+e.fn+".json",ld$.fetch(e,{},{type:"text"})):this$.ldcv.finish.toggle(!0)}).then(function(ret){var e;try{this$.data=JSON.parse(ret)}catch(e$){e=e$,this$.data=eval(ret)}return this$.lv=lv,this$.user.startScore=this$.user.score,this$.prepare(),this$.setMode(mode||"play")}).catch(function(){return this$.ldcv.finish.toggle(!0)})},convert:function(e){var t=e.x,s=e.y,i=e.f,r=e.src,e=e.des;return this.tiles[i][s][t]=e,this.nodes[i][s][t].classList.remove(stage.tileinfo[r].name),this.nodes[i][s][t].classList.add(stage.tileinfo[e].name)},transform:function(e){for(var t,s,i,r,n,o,a,u,h,d=[],l=e.src,p=e.des,e=[this.tiles,this.nodes,stage.tileinfo,this.dim],c=e[0],f=e[1],m=e[2],g=e[3],v=0,y=g.f;v<y;++v){for(t=v,s=[],i=0,r=g.h;i<r;++i){for(n=i,o=[],a=0,u=g.w;a<u;++a)h=a,c[t][n][h]===l&&(c[t][n][h]=p,f[t][n][h].classList.remove(m[l].name),o.push(f[t][n][h].classList.add(m[p].name)));s.push(o)}d.push(s)}return d}}),stage.prototype.firekey=function(e){var f,m,t,s,i,r,n,o,a,u,g=this,h=[stage.tileinfo,this.user,!0],d=h[0],v=h[1],l=h[2],p=(h=[stage.dim.size,stage.dim.vp])[0],c=h[1];if(requestAnimationFrame(function(e){return g.firekey(e)}),v.moving&&!(v.lastMoveTime&&e-v.lastMoveTime<160)&&(v.lastMoveTime=e,h=function(){switch(v.dir){case 0:return[-1,0];case 1:return[0,-1];case 2:return[1,0];case 3:return[0,1];default:return[NaN,NaN]}}(),f=h[0],m=h[1],!isNaN(f)&&(u=(h=(t=function(){var e,t,s,i,r,n,o,a,u,h,d,l,p=[e={x:v.x,y:v.y},t=s={x:v.x+f,y:v.y+m,f:v.f},i={x:v.x+2*f,y:v.y+2*m}],c=[v.f-1,v.f,v.f+1];if(t.x<0||t.x>=g.dim.w||t.y<0||t.y>=g.dim.h||c[1]<0||c[1]>=g.dim.f)return[];for(r=[],n=0;n<3;++n){for(o=n,a=[],u=0;u<3;++u)d=(h=[p[l=u].x,p[l].y,c[o]])[1],l=h[2],!((h=h[0])<0||h>=g.dim.w||d<0||d>=g.dim.h||l<0||l>=g.dim.f)&&g.tiles[l]?a.push(g.tiles[l][d][h]):a.push(0);r.push(a)}return[p,c,r,e,t,i,s]})())[0],s=h[1],i=h[2],h[3],r=h[4],n=h[5],o=h[6],u))){if("edit"===this.mode)return import$(v,o),void(this.cursor.entering?(this.tiles[v.f][v.y][v.x]=this.cursor.key,this.render()):this.renderUser());if("j"!==i[1][0]||!d[i[1][1]]||!d[i[1][1]].over||d[i[2][1]]&&!d[i[2][1]].through||(v.f=v.f+1,u=(h=t())[0],s=h[1],i=h[2],h[3],r=h[4],n=h[5],o=h[6],u)){if(d[i[1][1]]&&d[i[1][1]].score&&(this.tiles[s[1]][r.y][r.x]="a",(a=this.nodes[s[1]][r.y][r.x])&&a.parentNode&&a.parentNode.removeChild(a),this.nodes[s[1]][r.y][r.x]=null,this.user.score=(this.user.score||0)+d[i[1][1]].score,this.sndPlay("get"),this.view.render()),"m"===i[1][1]&&(this.transform({src:"o",des:"d"}),this.transform({src:"p",des:"a"}),this.convert({f:s[1],x:r.x,y:r.y,src:"m",des:"n"}),this.sndPlay("press"),this.render()),"e"===i[1][1]){if("a"!==(h=i[1][2])&&"f"!==h&&"n"!==h&&"o"!==h)return void this.sndPlay("hit");if(u=(h=0<=s[0]&&(!d[i[0][2]]||d[i[0][2]].fill)?[s[0],"c"]:[s[1],"e"])[0],h=h[1],d[i[0][2]]&&!d[i[0][2]].fill&&d[i[0][2]].through)return;this.tiles[s[1]][r.y][r.x]="a",this.tiles[u][n.y][n.x]=h,this.nodes[s[1]][r.y][r.x].classList.remove(d.e.name),this.nodes[s[1]][r.y][r.x].classList.add(d[h].name),import$(this.nodes[s[1]][r.y][r.x].style,{left:n.x*p+"px",top:n.y*p-u*c+"px",zIndex:this.zIndex({f:u,y:n.y,x:n.x,p:0})}),(c=this.nodes[u][n.y][n.x])&&c.parentNode.removeChild(c),this.nodes[u][n.y][n.x]=this.nodes[s[1]][r.y][r.x],this.nodes[s[1]][r.y][r.x]=null,this.sndPlay("push"),l=!1}if("h"===i[1][1]&&(this.sndPlay("key"),this.transform({src:"g",des:"i"}),this.user.item.push(7),this.tiles[s[1]][r.y][r.x]="a",(a=this.nodes[s[1]][r.y][r.x])&&a.parentNode&&a.parentNode.removeChild(a),this.nodes[s[1]][r.y][r.x]=null),"i"===i[1][1]){if(this.sndPlay("pass"),!this.editData)return this.load({lv:this.lv+1});this.setMode("edit")}if("a"===i[1][1]&&"j"===i[0][1]&&(o.f=o.f-1,l=!1),l){if(d[i[1][1]]&&!d[i[1][1]].through)return;if(d[i[0][1]]&&!d[i[0][1]].over)return}return import$(v,o),this.renderUser()}}},s=new stage,s.init(),args={},(window.location.search||"").substring(1).split("&").map(function(e){var t=e.split("=").map(function(e){return decodeURIComponent(e)}),e=t[0],t=t[1];return args[e]=t}),args.mapset&&s.load({mapset:args.mapset,lv:args.lv||0});
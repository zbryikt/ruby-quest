function import$(e,t){var s={}.hasOwnProperty;for(var i in t)s.call(t,i)&&(e[i]=t[i]);return e}function in$(e,t){for(var s=-1,i=t.length>>>0;++s<i;)if(e===t[s])return!0;return!1}var cp,stage,s;cp=function(e){return JSON.parse(JSON.stringify(e))},stage=function(){return this.data={},this.dim={},this.user={item:[]},this.cursor={key:"c"},this.lv=0,this.loader={},this.ldcv={},this.snd={},this.mode="intro",this},stage.dim={size:32,vp:12},stage.tileinfo={a:{name:"void",through:!0,over:!1,fill:!0,push:!0},b:{name:"bedrock",through:!1,over:!0,fill:!1,push:!1},c:{name:"earth",through:!1,over:!0,fill:!1,push:!1},d:{name:"wall",through:!1,over:!0,fill:!1,push:!1},e:{name:"stool",through:!1,over:!0,fill:!1,push:!1},f:{name:"grass",through:!1,over:!1,fill:!0,push:!1},g:{name:"door",through:!0,over:!1,fill:!1,push:!1},h:{name:"key",through:!0,over:!1,fill:!1,push:!1},i:{name:"exit",through:!0,over:!1,fill:!1,push:!1},j:{name:"stair",through:!0,over:!1,fill:!1,push:!1},k:{name:"gravel",through:!0,over:!1,fill:!1,push:!1},l:{name:"sapphire",through:!0,over:!1,fill:!1,push:!1,score:10},m:{name:"button",through:!0,over:!1,fill:!1,push:!1},n:{name:"button-pressed",through:!0,over:!1,fill:!0,push:!1},o:{name:"trapwall",through:!0,over:!1,fill:!0,push:!1},p:{name:"trapdoor",through:!1,over:!0,fill:!1,push:!1},q:{name:"amethyst",through:!0,over:!1,fill:!1,push:!1,score:20}},stage.prototype=import$(Object.create(Object.prototype),{restart:function(){return this.user.score=this.user.startScore,this.load({lv:this.lv})},reset:function(){return this.user.score=0,this.load({lv:1})},sndPause:function(e){return this.snd[e].pause()},sndPlay:function(e,t){return null==t&&(t={}),t.loop&&(this.snd[e].loop=!0),this.snd[e].currentTime=0,this.snd[e].play()},setMode:function(e){return null==e&&(e="edit"),"edit"===e?(this.editData&&(this.data=cp(this.editData),this.tiles=this.data.tiles,this.users=this.data.users),this.mode="edit",this.sndPause("bgm"),this.render()):"intro"===e?(this.mode="intro",this.sndPause("bgm"),this.render()):(import$(this.user,this.data.user),this.mode="play",this.render())},init:function(){var e,t=this;return this.view=e=new ldView({initRender:!1,root:document.body,init:{finish:function(e){var s;return s=e.node,t.ldcv.finish=new ldCover({root:s})},picked:function(e){return e.node.appendChild(t.el.sampleTile.cloneNode(!0))}},text:{lv:function(){return t.lv||1},score:function(){return t.user.score||0}},handler:{mapset:{list:function(){return["basic"]},key:function(e){return e},handler:function(e){var t,s;return t=e.node,s=e.data,t.innerText=s,t.value=s}},"on-mode":function(e){var s,i;return s=e.node,i=s.getAttribute("data-mode"),s.classList.toggle("d-none",i!==t.mode)},"sample-tile":function(){},field:function(){},user:function(){},cursor:function(){},scene:function(){},lv:function(){},score:function(){},picked:function(e){return e.node.childNodes[0].setAttribute("class",["tile"].concat([stage.tileinfo[t.cursor.key].name]).join(" "))},screen:function(e){var s,i;return s=e.node,i=s.getAttribute("data-name").split(" "),s.classList.toggle("d-none",!in$(t.mode,i))}},action:{click:{start:function(){return t.setMode("play"),function(e){return t.load({lv:1,path:function(t){return"/assets/map/"+e+"/"+t+".json"}})}(e.get("selected-mapset").value)},"go-edit":function(){return t.setMode("edit")},"test-run":function(){return t.editData=cp(t.data),t.setMode("play")},download:function(){var e,s;return e=URL.createObjectURL(new Blob([JSON.stringify(t.data)],{type:"application/json"})),s=ld$.create({name:"a",attr:{href:e,download:"result.json"}}),document.body.appendChild(s),s.click(),document.body.removeChild(s)},restart:function(){return t.restart()},reset:function(){return t.ldcv.finish.toggle(!1),t.reset()},ext:function(e){var s,i,r;return s=e.node,0===(i=+s.getAttribute("data-type"))&&t.tiles.map(function(e){return e.map(function(e){return e.splice(0,0,cp(e[0]))})}),1===i&&t.tiles.map(function(e){return e.splice(0,0,cp(e[0]))}),2===i&&t.tiles.map(function(e){return e.map(function(e){return e.splice(e.length,0,cp(e[e.length-1]))})}),3===i&&t.tiles.map(function(e){return e.splice(e.length,0,cp(e[e.length-1]))}),4===i&&t.tiles.map(function(e){return e.map(function(e){return e.splice(0,1)})}),5===i&&t.tiles.map(function(e){return e.splice(0,1)}),6===i&&t.tiles.map(function(e){return e.map(function(e){return e.splice(e.length-1,1)})}),7===i&&t.tiles.map(function(e){return e.splice(e.length-1,1)}),8===i&&t.tiles.splice(t.tiles.length,0,(r=t.tiles)[r.length-1].map(function(e){return e.map(function(){return"a"})})),9===i&&t.tiles.splice(0,0,cp(t.tiles[0])),10===i&&t.tiles.length>1&&t.tiles.splice(t.tiles.length-1,1),11===i&&t.tiles.length>1&&t.tiles.splice(0,1),t.prepare(),t.render()}}}}),this.el={sampleTile:e.get("sample-tile").cloneNode(!0),scene:e.get("scene"),field:e.get("field"),user:e.get("user"),cursor:e.get("cursor"),picked:e.get("picked")},this.el.sampleTile.classList.remove("d-none"),this.view.render(),this.snd.bgm=new Audio("/assets/snd/adventure.mp3"),this.snd.get=new Audio("/assets/snd/get.ogg"),this.snd.pass=new Audio("/assets/snd/pass.ogg"),this.snd.key=new Audio("/assets/snd/key.ogg"),this.snd.push=new Audio("/assets/snd/push.ogg"),this.snd.hit=new Audio("/assets/snd/hit.ogg"),requestAnimationFrame(function(e){return t.firekey(e)}),document.addEventListener("keyup",function(e){var s,i,r;if(32===(s=e.which)&&(t.cursor.entering=!1),!(s<37||s>40))return i=t.user,r=s-37,i.dir===r?i.moving=!1:void 0}),document.addEventListener("keydown",function(e){var s,i,r,n,o,a,h,u,d,l,c;if(s=[t.user,e.which],i=s[0],r=s[1],t.snd.bgm.paused&&"play"===t.mode&&t.sndPlay("bgm",{loop:!0}),82===r&&"play"===t.mode)return t.restart();if("edit"===t.mode){if(80===r&&((n=t.data.user).x=(s=t.user).x,n.y=s.y,n.f=s.f,t.renderUser()),83!==r&&87!==r||(o=83===r?-1:1,i.f=(n=i.f+o)>0?n:0,i.f>=t.dim.f&&(i.f=t.dim.f-1),t.tiles[i.f]||(t.tiles[i.f]=function(){var e,t,s,i,r,n=[];for(e=0,t=this.dim.h;e<t;++e){for(a=e,s=[],i=0,r=this.dim.w;i<r;++i)h=i,s.push("a");n.push(s)}return n}.call(t)),t.render()),65===r||68===r){d=[];for(l in stage.tileinfo)d.push(l);u=d,o=65===r?-1:1,t.cursor.key=u[(u.indexOf(t.cursor.key)+o+u.length)%u.length],t.renderUser()}8===r&&(t.tiles[i.f][i.y][i.x]="a",t.render()),32===r&&(t.cursor.entering=!0,t.tiles[i.f][i.y][i.x]=t.cursor.key,t.render()),70===r&&(t.tiles[i.f].map(function(e){var s,i,r,n=[];for(s=0,i=e.length;s<i;++s)r=s,n.push(e[r]=t.cursor.key);return n}),t.render())}return r<37||r>40?void 0:(c=r-37,i.dir===c&&i.moving||(i.lastMoveTime=null),i.dir=c,i.moving=!0,t.el.user.style.backgroundPositionY=1.4964*-stage.dim.size*[2,1,3,0][c]+"px")})},zIndex:function(e){var t,s,i;return e.x,t=e.y,s=e.f,i=e.p,2*(s*this.dim.w*this.dim.h+t)+(i?1:0)},renderUser:function(){var e,t,s,i,r,n;return e=[stage.dim.size,stage.dim.vp],t=e[0],s=e[1],e="play"===this.mode?this.user:this.data.user,i=e.x,r=e.y,n=e.f,import$(this.el.user.style,{left:i*t+"px",top:r*t-n*s+"px",zIndex:this.zIndex({f:n,y:r,x:i,p:1})}),import$(this.el.cursor.style,{left:this.user.x*t+"px",top:this.user.y*t-this.user.f*s+"px",zIndex:this.zIndex({f:this.user.f,y:this.user.y,x:this.user.x,p:1})}),this.el.cursor.style.display="edit"===this.mode?"block":"none",this.view.render("picked")},render:function(){var e,t,s,i,r,n,o,a,h,u,d,l,c,f,p,m,g,v,y,x,w;for(t=(e=[this.dim,this.tiles,stage.tileinfo])[0],s=e[1],i=e[2],r=(e=[stage.dim.size,stage.dim.vp])[0],n=e[1],o=(e=[this.el.sampleTile,this.el.field,this.el.scene])[0],a=e[1],import$(e[2].style,{width:t.w*r+"px",height:t.h*r+n+"px"}),a.innerHTML="",this.nodes=[],h=[],u=0,d=t.f;u<d;++u){for(l=u,c=[],f=0,p=t.h;f<p;++f){for(m=f,g=[],v=0,y=t.w;v<y;++v)x=v,w=o.cloneNode(!0),a.appendChild(w),w.classList.add(i[s[l][m][x]].name),import$(w.style,{left:x*r+"px",top:m*r-l*n+"px",zIndex:this.zIndex({f:l,x:x,y:m,p:0})}),g.push(w);c.push(g)}h.push(c)}return this.nodes=h,this.renderUser(),this.view.render()},prepare:function(){return this.tiles=this.data.tiles,import$(this.user,this.data.user),import$(this.dim,{f:this.data.tiles.length,h:this.data.tiles[0].length,w:this.data.tiles[0][0].length})},edit:function(){var e,t;return this.mode="edit",this.data={user:{x:0,y:0,f:0},tiles:[function(){var s,i,r,n=[];for(s=0;s<10;++s){for(e=s,i=[],r=0;r<10;++r)t=r,i.push("a");n.push(i)}return n}()]},this.prepare(),this.render()},load:function(arg$){var lv,path,mode,this$=this;return lv=arg$.lv,path=arg$.path,mode=arg$.mode,path=path||this.loader.path,this.loader.path=path,ld$.fetch(path?path(lv):"/js/map/"+lv+".js",{},{type:"text"}).then(function(ret){var e;try{this$.data=JSON.parse(ret)}catch(e$){e=e$,this$.data=eval(ret)}return this$.lv=lv,this$.user.startScore=this$.user.score,this$.prepare(),this$.setMode(mode||"play")}).catch(function(){return this$.ldcv.finish.toggle(!0)})},convert:function(e){var t,s,i,r,n;return t=e.x,s=e.y,i=e.f,r=e.src,n=e.des,this.tiles[i][s][t]=n,this.nodes[i][s][t].classList.remove(stage.tileinfo[r].name),this.nodes[i][s][t].classList.add(stage.tileinfo[n].name)},transform:function(e){var t,s,i,r,n,o,a,h,u,d,l,c,f,p,m,g,v,y,x=[];for(t=e.src,s=e.des,r=(i=[this.tiles,this.nodes,stage.tileinfo,this.dim])[0],n=i[1],o=i[2],h=0,u=(a=i[3]).f;h<u;++h){for(d=h,l=[],c=0,f=a.h;c<f;++c){for(p=c,m=[],g=0,v=a.w;g<v;++g)y=g,r[d][p][y]===t&&(r[d][p][y]=s,n[d][p][y].classList.remove(o[t].name),m.push(n[d][p][y].classList.add(o[s].name)));l.push(m)}x.push(l)}return x}}),stage.prototype.firekey=function(e){var t,s,i,r,n,o,a,h,u,d,l,c,f,p,m,g,v,y,x,w=this;if(t=[stage.tileinfo,this.user,!0],s=t[0],i=t[1],r=t[2],t=[stage.dim.size,stage.dim.vp],n=t[0],o=t[1],requestAnimationFrame(function(e){return w.firekey(e)}),i.moving&&!(i.lastMoveTime&&e-i.lastMoveTime<100)&&(i.lastMoveTime=e,t=function(){switch(i.dir){case 0:return[-1,0];case 1:return[0,-1];case 2:return[1,0];case 3:return[0,1];default:return[NaN,NaN]}}(),a=t[0],h=t[1],!isNaN(a)&&(u=function(){var e,t,s,r,n,o,u,d,l,c,f,p,m,g,v,y,x;if(e=[t={x:i.x,y:i.y},s=r={x:i.x+a,y:i.y+h,f:i.f},n={x:i.x+2*a,y:i.y+2*h}],o=[i.f-1,i.f,i.f+1],s.x<0||s.x>=w.dim.w||s.y<0||s.y>=w.dim.h||o[1]<0||o[1]>=w.dim.f)return[];for(d=[],l=0;l<3;++l){for(c=l,f=[],p=0;p<3;++p)v=(g=[e[m=p].x,e[m].y,o[c]])[0],y=g[1],x=g[2],v<0||v>=w.dim.w||y<0||y>=w.dim.h||x<0||x>=w.dim.f?f.push(0):w.tiles[x]?f.push(w.tiles[x][y][v]):f.push(0);d.push(f)}return u=d,[e,o,u,t,s,n,r]},t=u(),d=t[0],l=t[1],c=t[2],t[3],f=t[4],p=t[5],m=t[6],d))){if("edit"===this.mode)return import$(i,m),void(this.cursor.entering?(this.tiles[i.f][i.y][i.x]=this.cursor.key,this.render()):this.renderUser());if("j"!==c[1][0]||!s[c[1][1]]||!s[c[1][1]].over||s[c[2][1]]&&!s[c[2][1]].through||(i.f=i.f+1,t=u(),d=t[0],l=t[1],c=t[2],t[3],f=t[4],p=t[5],m=t[6],d)){if(s[c[1][1]]&&s[c[1][1]].score&&(this.tiles[l[1]][f.y][f.x]="a",(g=this.nodes[l[1]][f.y][f.x])&&g.parentNode&&g.parentNode.removeChild(g),this.nodes[l[1]][f.y][f.x]=null,this.user.score=(this.user.score||0)+s[c[1][1]].score,this.sndPlay("get"),this.view.render()),"m"===c[1][1]&&(this.transform({src:"o",des:"d"}),this.transform({src:"p",des:"a"}),this.convert({f:l[1],x:f.x,y:f.y,src:"m",des:"n"}),this.render()),"e"===c[1][1]){if("a"!==(t=c[1][2])&&"f"!==t&&"n"!==t&&"o"!==t)return void this.sndPlay("hit");if(t=l[0]>=0&&(!s[c[0][2]]||s[c[0][2]].fill)?[l[0],"c"]:[l[1],"e"],v=t[0],y=t[1],s[c[0][2]]&&!s[c[0][2]].fill&&s[c[0][2]].through)return;this.tiles[l[1]][f.y][f.x]="a",this.tiles[v][p.y][p.x]=y,this.nodes[l[1]][f.y][f.x].classList.remove(s.e.name),this.nodes[l[1]][f.y][f.x].classList.add(s[y].name),import$(this.nodes[l[1]][f.y][f.x].style,{left:p.x*n+"px",top:p.y*n-v*o+"px",zIndex:this.zIndex({f:v,y:p.y,x:p.x,p:0})}),(x=this.nodes[v][p.y][p.x])&&x.parentNode.removeChild(x),this.nodes[v][p.y][p.x]=this.nodes[l[1]][f.y][f.x],this.nodes[l[1]][f.y][f.x]=null,this.sndPlay("push"),r=!1}if("h"===c[1][1]&&(this.sndPlay("key"),this.transform({src:"g",des:"i"}),this.user.item.push(7),this.tiles[l[1]][f.y][f.x]="a",(g=this.nodes[l[1]][f.y][f.x])&&g.parentNode&&g.parentNode.removeChild(g),this.nodes[l[1]][f.y][f.x]=null),"i"===c[1][1]){if(this.sndPlay("pass"),!this.editData)return this.load({lv:this.lv+1});this.setMode("edit")}if("a"===c[1][1]&&"j"===c[0][1]&&(m.f=m.f-1,r=!1),r){if(s[c[1][1]]&&!s[c[1][1]].through)return;if(s[c[0][1]]&&!s[c[0][1]].over)return}return import$(i,m),this.renderUser()}}},(s=new stage).init();
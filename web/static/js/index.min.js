function import$(e,t){var i={}.hasOwnProperty;for(var s in t)i.call(t,s)&&(e[s]=t[s]);return e}var cp,stage,s;cp=function(e){return JSON.parse(JSON.stringify(e))},stage=function(){return this.data={},this.dim={},this.user={item:[]},this.cursor={key:"c"},this.lv=0,this.loader={},this.ldcv={},this.snd={},this.mode="play",this},stage.dim={size:32,vp:12},stage.tileinfo={a:{name:"void",through:!0,over:!1,fill:!0,push:!0},b:{name:"bedrock",through:!1,over:!0,fill:!1,push:!1},c:{name:"earth",through:!1,over:!0,fill:!1,push:!1},d:{name:"wall",through:!1,over:!0,fill:!1,push:!1},e:{name:"stool",through:!1,over:!0,fill:!1,push:!1},f:{name:"grass",through:!1,over:!1,fill:!0,push:!1},g:{name:"door",through:!0,over:!1,fill:!1,push:!1},h:{name:"key",through:!0,over:!1,fill:!1,push:!1},i:{name:"exit",through:!0,over:!1,fill:!1,push:!1},j:{name:"stair",through:!0,over:!1,fill:!1,push:!1},k:{name:"gravel",through:!0,over:!1,fill:!1,push:!1},l:{name:"sapphire",through:!0,over:!1,fill:!1,push:!1,score:10}},stage.prototype=import$(Object.create(Object.prototype),{restart:function(){return this.user.score=this.user.startScore,this.load({lv:this.lv})},reset:function(){return this.user.score=0,this.load({lv:1})},sndPlay:function(e){return this.snd[e].currentTime=0,this.snd[e].play()},setMode:function(e){return null==e&&(e="edit"),"edit"===e?(this.editData&&(this.data=cp(this.editData),this.tiles=this.data.tiles,this.users=this.data.users),this.mode="edit",this.render()):(this.editData=cp(this.data),import$(this.user,this.data.user),this.mode="play",this.render())},init:function(){var e,t=this;return this.view=e=new ldView({initRender:!1,root:document.body,init:{finish:function(e){var i;return i=e.node,t.ldcv.finish=new ldCover({root:i})},picked:function(e){return e.node.appendChild(t.el.sampleTile.cloneNode(!0))}},text:{lv:function(){return t.lv||1},score:function(){return t.user.score||0}},handler:{"on-mode":function(e){var i,s;return i=e.node,s=i.getAttribute("data-mode"),i.classList.toggle("d-none",s!==t.mode)},"sample-tile":function(){},field:function(){},user:function(){},cursor:function(){},scene:function(){},lv:function(){},score:function(){},picked:function(e){return e.node.childNodes[0].setAttribute("class",["tile"].concat([stage.tileinfo[t.cursor.key].name]).join(" "))}},action:{click:{"go-edit":function(){return t.setMode("edit")},"test-run":function(){return t.setMode("play")},download:function(){var e,i;return e=URL.createObjectURL(new Blob([JSON.stringify(t.data)],{type:"application/json"})),i=ld$.create({name:"a",attr:{href:e,download:"result.json"}}),document.body.appendChild(i),i.click(),document.body.removeChild(i)},restart:function(){return t.restart()},reset:function(){return t.ldcv.finish.toggle(!1),t.reset()},ext:function(e){var i,s,r;return i=e.node,0===(s=+i.getAttribute("data-type"))&&t.tiles.map(function(e){return e.map(function(e){return e.splice(0,0,cp(e[0]))})}),1===s&&t.tiles.map(function(e){return e.splice(0,0,cp(e[0]))}),2===s&&t.tiles.map(function(e){return e.map(function(e){return e.splice(e.length,0,cp(e[e.length-1]))})}),3===s&&t.tiles.map(function(e){return e.splice(e.length,0,cp(e[e.length-1]))}),4===s&&t.tiles.map(function(e){return e.map(function(e){return e.splice(0,1)})}),5===s&&t.tiles.map(function(e){return e.splice(0,1)}),6===s&&t.tiles.map(function(e){return e.map(function(e){return e.splice(e.length-1,1)})}),7===s&&t.tiles.map(function(e){return e.splice(e.length-1,1)}),8===s&&t.tiles.splice(t.tiles.length,0,(r=t.tiles)[r.length-1].map(function(e){return e.map(function(){return"a"})})),9===s&&t.tiles.splice(0,0,cp(t.tiles[0])),10===s&&t.tiles.length>1&&t.tiles.splice(t.tiles.length-1,1),11===s&&t.tiles.length>1&&t.tiles.splice(0,1),t.prepare(),t.render()}}}}),this.el={sampleTile:e.get("sample-tile").cloneNode(!0),scene:e.get("scene"),field:e.get("field"),user:e.get("user"),cursor:e.get("cursor"),picked:e.get("picked"),bgm:e.get("bgm")},this.el.sampleTile.classList.remove("d-none"),this.view.render(),this.snd.get=new Audio("/assets/snd/get.ogg"),this.snd.pass=new Audio("/assets/snd/pass.ogg"),this.snd.key=new Audio("/assets/snd/key.ogg"),this.snd.push=new Audio("/assets/snd/push.ogg"),this.snd.hit=new Audio("/assets/snd/hit.ogg"),requestAnimationFrame(function(e){return t.firekey(e)}),document.addEventListener("keyup",function(e){var i,s,r;if(32===(i=e.which)&&(t.cursor.entering=!1),!(i<37||i>40))return s=t.user,r=i-37,s.dir===r?s.moving=!1:void 0}),document.addEventListener("keydown",function(e){var i,s,r,n,o,h,a,u,l,d,c;if(i=[t.user,e.which],s=i[0],r=i[1],t.el.bgm.paused&&t.el.bgm.play(),82===r&&"play"===t.mode)return t.restart();if("edit"===t.mode){if(80===r&&((n=t.data.user).x=(i=t.user).x,n.y=i.y,n.f=i.f,t.renderUser()),83!==r&&87!==r||(o=83===r?-1:1,s.f=(n=s.f+o)>0?n:0,s.f>=t.dim.f&&(s.f=t.dim.f-1),t.tiles[s.f]||(t.tiles[s.f]=function(){var e,t,i,s,r,n=[];for(e=0,t=this.dim.h;e<t;++e){for(h=e,i=[],s=0,r=this.dim.w;s<r;++s)a=s,i.push("a");n.push(i)}return n}.call(t)),t.render()),65===r||68===r){l=[];for(d in stage.tileinfo)l.push(d);u=l,o=65===r?-1:1,t.cursor.key=u[(u.indexOf(t.cursor.key)+o+u.length)%u.length],t.renderUser()}8===r&&(t.tiles[s.f][s.y][s.x]="a",t.render()),32===r&&(t.cursor.entering=!0,t.tiles[s.f][s.y][s.x]=t.cursor.key,t.render()),70===r&&(t.tiles[s.f].map(function(e){var i,s,r,n=[];for(i=0,s=e.length;i<s;++i)r=i,n.push(e[r]=t.cursor.key);return n}),t.render())}return r<37||r>40?void 0:(c=r-37,s.dir===c&&s.moving||(s.lastMoveTime=null),s.dir=c,s.moving=!0,t.el.user.style.backgroundPositionY=1.4964*-stage.dim.size*[2,1,3,0][c]+"px")})},zIndex:function(e){var t,i,s;return e.x,t=e.y,i=e.f,s=e.p,2*(i*this.dim.w*this.dim.h+t)+(s?1:0)},renderUser:function(){var e,t,i,s,r,n;return e=[stage.dim.size,stage.dim.vp],t=e[0],i=e[1],e="play"===this.mode?this.user:this.data.user,s=e.x,r=e.y,n=e.f,import$(this.el.user.style,{left:s*t+"px",top:r*t-n*i+"px",zIndex:this.zIndex({f:n,y:r,x:s,p:1})}),import$(this.el.cursor.style,{left:this.user.x*t+"px",top:this.user.y*t-this.user.f*i+"px",zIndex:this.zIndex({f:this.user.f,y:this.user.y,x:this.user.x,p:1})}),this.el.cursor.style.display="edit"===this.mode?"block":"none",this.view.render("picked")},render:function(){var e,t,i,s,r,n,o,h,a,u,l,d,c,p,f,m,g,v,y,x,w;for(t=(e=[this.dim,this.tiles,stage.tileinfo])[0],i=e[1],s=e[2],r=(e=[stage.dim.size,stage.dim.vp])[0],n=e[1],o=(e=[this.el.sampleTile,this.el.field,this.el.scene])[0],h=e[1],import$(e[2].style,{width:t.w*r+"px",height:t.h*r+n+"px"}),h.innerHTML="",this.nodes=[],a=[],u=0,l=t.f;u<l;++u){for(d=u,c=[],p=0,f=t.h;p<f;++p){for(m=p,g=[],v=0,y=t.w;v<y;++v)x=v,w=o.cloneNode(!0),h.appendChild(w),w.classList.add(s[i[d][m][x]].name),import$(w.style,{left:x*r+"px",top:m*r-d*n+"px",zIndex:this.zIndex({f:d,x:x,y:m,p:0})}),g.push(w);c.push(g)}a.push(c)}return this.nodes=a,this.renderUser(),this.view.render()},prepare:function(){return this.tiles=this.data.tiles,import$(this.user,this.data.user),import$(this.dim,{f:this.data.tiles.length,h:this.data.tiles[0].length,w:this.data.tiles[0][0].length})},edit:function(){var e,t;return this.mode="edit",this.data={user:{x:0,y:0,f:0},tiles:[function(){var i,s,r,n=[];for(i=0;i<10;++i){for(e=i,s=[],r=0;r<10;++r)t=r,s.push("a");n.push(s)}return n}()]},this.prepare(),this.render()},load:function(arg$){var lv,path,this$=this;return lv=arg$.lv,path=arg$.path,path=path||this.loader.path,this.loader.path=path,ld$.fetch(path?path(lv):"/js/map/"+lv+".js",{},{type:"text"}).then(function(ret){var e;try{this$.data=JSON.parse(ret)}catch(e$){e=e$,this$.data=eval(ret)}return this$.lv=lv,this$.user.startScore=this$.user.score,this$.prepare(),this$.render()}).catch(function(){return this$.ldcv.finish.toggle(!0)})},transform:function(e){var t,i,s,r,n,o,h,a,u,l,d,c,p,f,m,g,v,y,x=[];for(t=e.src,i=e.des,r=(s=[this.tiles,this.nodes,stage.tileinfo,this.dim])[0],n=s[1],o=s[2],a=0,u=(h=s[3]).f;a<u;++a){for(l=a,d=[],c=0,p=h.h;c<p;++c){for(f=c,m=[],g=0,v=h.w;g<v;++g)y=g,r[l][f][y]===t&&(r[l][f][y]=i,n[l][f][y].classList.remove(o[t].name),m.push(n[l][f][y].classList.add(o[i].name)));d.push(m)}x.push(d)}return x}}),stage.prototype.firekey=function(e){var t,i,s,r,n,o,h,a,u,l,d,c,p,f,m,g,v,y,x,w=this;if(t=[stage.tileinfo,this.user,!0],i=t[0],s=t[1],r=t[2],t=[stage.dim.size,stage.dim.vp],n=t[0],o=t[1],requestAnimationFrame(function(e){return w.firekey(e)}),s.moving&&!(s.lastMoveTime&&e-s.lastMoveTime<100)&&(s.lastMoveTime=e,t=function(){switch(s.dir){case 0:return[-1,0];case 1:return[0,-1];case 2:return[1,0];case 3:return[0,1];default:return[NaN,NaN]}}(),h=t[0],a=t[1],!isNaN(h)&&(u=function(){var e,t,i,r,n,o,u,l,d,c,p,f,m,g,v,y,x;if(e=[t={x:s.x,y:s.y},i=r={x:s.x+h,y:s.y+a,f:s.f},n={x:s.x+2*h,y:s.y+2*a}],o=[s.f-1,s.f,s.f+1],i.x<0||i.x>=w.dim.w||i.y<0||i.y>=w.dim.h||o[1]<0||o[1]>=w.dim.f)return[];for(l=[],d=0;d<3;++d){for(c=d,p=[],f=0;f<3;++f)v=(g=[e[m=f].x,e[m].y,o[c]])[0],y=g[1],x=g[2],v<0||v>=w.dim.w||y<0||y>=w.dim.h||x<0||x>=w.dim.f?p.push(0):w.tiles[x]?p.push(w.tiles[x][y][v]):p.push(0);l.push(p)}return u=l,[e,o,u,t,i,n,r]},t=u(),l=t[0],d=t[1],c=t[2],t[3],p=t[4],f=t[5],m=t[6],l))){if("edit"===this.mode)return import$(s,m),void(this.cursor.entering?(this.tiles[s.f][s.y][s.x]=this.cursor.key,this.render()):this.renderUser());if("j"!==c[1][0]||!i[c[1][1]]||!i[c[1][1]].over||i[c[2][1]]&&!i[c[2][1]].through||(s.f=s.f+1,t=u(),l=t[0],d=t[1],c=t[2],t[3],p=t[4],f=t[5],m=t[6],l)){if(i[c[1][1]]&&i[c[1][1]].score&&(this.tiles[d[1]][p.y][p.x]="a",(g=this.nodes[d[1]][p.y][p.x])&&g.parentNode&&g.parentNode.removeChild(g),this.user.score=(this.user.score||0)+i[c[1][1]].score,this.sndPlay("get"),this.view.render()),"e"===c[1][1]){if("a"!==(t=c[1][2])&&"f"!==t)return void this.sndPlay("hit");v=(t=d[0]>=0&&(!i[c[0][2]]||i[c[0][2]].fill)?[d[0],"c"]:[d[1],"e"])[0],y=t[1],this.tiles[d[1]][p.y][p.x]="a",this.tiles[v][f.y][f.x]=y,this.nodes[d[1]][p.y][p.x].classList.remove(i.e.name),this.nodes[d[1]][p.y][p.x].classList.add(i[y].name),import$(this.nodes[d[1]][p.y][p.x].style,{left:f.x*n+"px",top:f.y*n-v*o+"px",zIndex:this.zIndex({f:v,y:f.y,x:f.x,p:0})}),(x=this.nodes[v][f.y][f.x])&&x.parentNode.removeChild(x),this.nodes[v][f.y][f.x]=this.nodes[d[1]][p.y][p.x],this.nodes[d[1]][p.y][p.x]=null,this.sndPlay("push"),r=!1}if("h"===c[1][1]&&(this.sndPlay("key"),this.transform({src:"g",des:"i"}),this.user.item.push(7),this.tiles[d[1]][p.y][p.x]=0,(g=this.nodes[d[1]][p.y][p.x])&&g.parentNode&&g.parentNode.removeChild(g)),"i"===c[1][1]){if(this.sndPlay("pass"),!this.editData)return this.load({lv:this.lv+1});this.setMode("edit")}if("a"===c[1][1]&&"j"===c[0][1]&&(m.f=m.f-1,r=!1),r){if(i[c[1][1]]&&!i[c[1][1]].through)return;if(i[c[0][1]]&&!i[c[0][1]].over)return}return import$(s,m),this.renderUser()}}},(s=new stage).init(),s.load({lv:1,path:function(e){return"/assets/map/"+e+".json"}});
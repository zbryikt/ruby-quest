function import$(e,t){var i={}.hasOwnProperty;for(var s in t)i.call(t,s)&&(e[s]=t[s]);return e}var stage,s;stage=function(){return this.data={},this.dim={},this.user={item:[]},this.lv=0,this.ldcv={},this},stage.dim={size:32,vp:12},stage.tileinfo={a:{name:"void",through:!0,over:!1,fill:!0,push:!0},b:{name:"bedrock",through:!1,over:!0,fill:!1,push:!1},c:{name:"earth",through:!1,over:!0,fill:!1,push:!1},d:{name:"wall",through:!1,over:!0,fill:!1,push:!1},e:{name:"stool",through:!1,over:!0,fill:!1,push:!1},f:{name:"grass",through:!1,over:!1,fill:!0,push:!1},g:{name:"door",through:!0,over:!1,fill:!1,push:!1},h:{name:"key",through:!0,over:!1,fill:!1,push:!1},i:{name:"exit",through:!0,over:!1,fill:!1,push:!1},j:{name:"stair",through:!0,over:!1,fill:!1,push:!1},k:{name:"gravel",through:!0,over:!1,fill:!1,push:!1},l:{name:"sapphire",through:!0,over:!1,fill:!1,push:!1,score:10}},stage.prototype=import$(Object.create(Object.prototype),{restart:function(){return this.load({lv:this.lv})},reset:function(){return this.user.score=0,this.load({lv:1})},init:function(){var e,t=this;return this.view=e=new ldView({root:document.body,init:{finish:function(e){var i;return i=e.node,t.ldcv.finish=new ldCover({root:i})}},text:{lv:function(){return t.lv||1},score:function(){return t.user.score||0}},handler:{"sample-tile":function(){},field:function(){},user:function(){},scene:function(){},lv:function(){},score:function(){}},action:{click:{restart:function(){return t.restart()},reset:function(){return t.ldcv.finish.toggle(!1),t.reset()}}}}),this.el={sampleTile:e.get("sample-tile").cloneNode(!0),scene:e.get("scene"),field:e.get("field"),user:e.get("user"),bgm:e.get("bgm")},this.el.sampleTile.classList.remove("d-none"),requestAnimationFrame(function(e){return t.firekey(e)}),document.addEventListener("keyup",function(e){var i,s;if(!(e.which<37||e.which>40))return i=t.user,s=e.which-37,i.dir===s?i.moving=!1:void 0}),document.addEventListener("keydown",function(e){var i,s;if(t.el.bgm.paused&&t.el.bgm.play(),!(e.which<37||e.which>40))return i=t.user,s=e.which-37,i.dir===s&&i.moving||(i.lastMoveTime=null),i.dir=s,i.moving=!0,t.el.user.style.backgroundPositionY=1.4964*-stage.dim.size*[2,1,3,0][s]+"px"}),document.addEventListener("keypress",function(e){if(114===e.which)return t.restart()})},zIndex:function(e){var t,i,s;return e.x,t=e.y,i=e.f,s=e.p,2*(i*this.dim.w*this.dim.h+t)+(s?1:0)},renderUser:function(){var e,t,i;return e=[stage.dim.size,stage.dim.vp],t=e[0],i=e[1],import$(this.el.user.style,{left:this.user.x*t+"px",top:this.user.y*t-this.user.f*i+"px",zIndex:this.zIndex({f:this.user.f,y:this.user.y,x:this.user.x,p:1})})},render:function(){var e,t,i,s,r,n,h,o,l,a,u,d,f,c,m,p,v,g,x,y,w;for(t=(e=[this.dim,this.tiles,stage.tileinfo])[0],i=e[1],s=e[2],r=(e=[stage.dim.size,stage.dim.vp])[0],n=e[1],h=(e=[this.el.sampleTile,this.el.field,this.el.scene])[0],o=e[1],import$(e[2].style,{width:t.w*r+"px",height:t.h*r+n*t.f+"px"}),o.innerHTML="",this.nodes=[],l=[],a=0,u=t.f;a<u;++a){for(d=a,f=[],c=0,m=t.h;c<m;++c){for(p=c,v=[],g=0,x=t.w;g<x;++g)y=g,w=h.cloneNode(!0),o.appendChild(w),w.classList.add(s[i[d][p][y]].name),import$(w.style,{left:y*r+"px",top:p*r-d*n+"px",zIndex:this.zIndex({f:d,x:y,y:p,p:0})}),v.push(w);f.push(v)}l.push(f)}return this.nodes=l,this.renderUser(),this.view.render()},load:function(arg$){var lv,this$=this;return lv=arg$.lv,ld$.fetch("/js/map/"+lv+".js",{},{type:"text"}).then(function(ret){return this$.data=eval(ret),this$.tiles=this$.data.tiles,import$(this$.user,this$.data.user),this$.lv=lv,import$(this$.dim,{f:this$.data.tiles.length,h:this$.data.tiles[0].length,w:this$.data.tiles[0][0].length}),this$.render()}).catch(function(){return this$.ldcv.finish.toggle(!0)})},transform:function(e){var t,i,s,r,n,h,o,l,a,u,d,f,c,m,p,v,g,x,y=[];for(t=e.src,i=e.des,r=(s=[this.tiles,this.nodes,stage.tileinfo,this.dim])[0],n=s[1],h=s[2],l=0,a=(o=s[3]).f;l<a;++l){for(u=l,d=[],f=0,c=o.h;f<c;++f){for(m=f,p=[],v=0,g=o.w;v<g;++v)x=v,r[u][m][x]===t&&(r[u][m][x]=i,n[u][m][x].classList.remove(h[t].name),p.push(n[u][m][x].classList.add(h[i].name)));d.push(p)}y.push(d)}return y}}),stage.prototype.firekey=function(e){var t,i,s,r,n,h,o,l,a,u,d,f,c,m,p,v,g,x,y,w=this;if(t=[stage.tileinfo,this.user,!0],i=t[0],s=t[1],r=t[2],t=[stage.dim.size,stage.dim.vp],n=t[0],h=t[1],requestAnimationFrame(function(e){return w.firekey(e)}),s.moving&&!(s.lastMoveTime&&e-s.lastMoveTime<100)&&(s.lastMoveTime=e,t=function(){switch(s.dir){case 0:return[-1,0];case 1:return[0,-1];case 2:return[1,0];case 3:return[0,1];default:return[NaN,NaN]}}(),o=t[0],l=t[1],!isNaN(o)&&(a=function(){var e,t,i,r,n,h,a,u,d,f,c,m,p,v,g,x,y;if(e=[t={x:s.x,y:s.y},i=r={x:s.x+o,y:s.y+l,f:s.f},n={x:s.x+2*o,y:s.y+2*l}],h=[s.f-1,s.f,s.f+1],i.x<0||i.x>=w.dim.w||i.y<0||i.y>=w.dim.h||h[1]<0||h[1]>=w.dim.f)return[];for(u=[],d=0;d<3;++d){for(f=d,c=[],m=0;m<3;++m)g=(v=[e[p=m].x,e[p].y,h[f]])[0],x=v[1],y=v[2],g<0||g>=w.dim.w||x<0||x>=w.dim.h||y<0||y>=w.dim.f?c.push(0):w.tiles[y]?c.push(w.tiles[y][x][g]):c.push(0);u.push(c)}return a=u,[e,h,a,t,i,n,r]},t=a(),u=t[0],d=t[1],f=t[2],t[3],c=t[4],m=t[5],p=t[6],u&&("j"!==f[1][0]||!i[f[1][1]]||!i[f[1][1]].over||i[f[2][1]]&&!i[f[2][1]].through||(s.f=s.f+1,t=a(),u=t[0],d=t[1],f=t[2],t[3],c=t[4],m=t[5],p=t[6],u))))){if(i[f[1][1]]&&i[f[1][1]].score&&(this.tiles[d[1]][c.y][c.x]="a",(v=this.nodes[d[1]][c.y][c.x])&&v.parentNode&&v.parentNode.removeChild(v),this.user.score=(this.user.score||0)+i[f[1][1]].score,this.view.render()),"e"===f[1][1]){if("a"!==(t=f[1][2])&&"f"!==t)return;g=(t=!i[f[0][2]]||i[f[0][2]].fill?[d[0],"c"]:[d[1],"e"])[0],x=t[1],this.tiles[d[1]][c.y][c.x]="a",this.tiles[g][m.y][m.x]=x,this.nodes[d[1]][c.y][c.x].classList.remove(i.e.name),this.nodes[d[1]][c.y][c.x].classList.add(i[x].name),import$(this.nodes[d[1]][c.y][c.x].style,{left:m.x*n+"px",top:m.y*n-g*h+"px",zIndex:this.zIndex({f:g,y:m.y,x:m.x,p:0})}),(y=this.nodes[g][m.y][m.x])&&y.parentNode.removeChild(y),this.nodes[g][m.y][m.x]=this.nodes[d[1]][c.y][c.x],this.nodes[d[1]][c.y][c.x]=null,r=!1}if("h"===f[1][1]&&(this.transform({src:"g",des:"i"}),this.user.item.push(7),this.tiles[d[1]][c.y][c.x]=0,(v=this.nodes[d[1]][c.y][c.x])&&v.parentNode&&v.parentNode.removeChild(v)),"i"===f[1][1])return this.load({lv:this.lv+1});if("a"===f[1][1]&&"j"===f[0][1]&&(p.f=p.f-1,r=!1),r){if(i[f[1][1]]&&!i[f[1][1]].through)return;if(i[f[0][1]]&&!i[f[0][1]].over)return}return import$(s,p),this.renderUser()}},(s=new stage).init(),s.load({lv:1});
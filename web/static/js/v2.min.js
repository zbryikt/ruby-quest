function import$(e,t){var i={}.hasOwnProperty;for(var s in t)i.call(t,s)&&(e[s]=t[s]);return e}var stage,s;stage=function(){return this.data={},this.dim={},this.user={item:[]},this},stage.dim={size:32,vp:12},stage.tileinfo={a:{name:"void",through:!0,over:!1,fill:!0,push:!0},b:{name:"bedrock",through:!1,over:!0,fill:!1,push:!1},c:{name:"earth",through:!1,over:!0,fill:!1,push:!1},d:{name:"wall",through:!1,over:!0,fill:!1,push:!1},e:{name:"stool",through:!1,over:!0,fill:!1,push:!1},f:{name:"grass",through:!1,over:!1,fill:!0,push:!1},g:{name:"door",through:!0,over:!1,fill:!1,push:!1},h:{name:"key",through:!0,over:!1,fill:!1,push:!1},i:{name:"exit",through:!0,over:!1,fill:!1,push:!1},j:{name:"stair",through:!0,over:!1,fill:!1,push:!1},k:{name:"gravel",through:!0,over:!1,fill:!1,push:!1},l:{name:"sapphire",through:!0,over:!1,fill:!1,push:!1}},stage.prototype=import$(Object.create(Object.prototype),{init:function(){var e,t=this;return e=new ldView({root:document.body,handler:{"sample-tile":function(){},field:function(){},user:function(){},scene:function(){}}}),this.el={sampleTile:e.get("sample-tile").cloneNode(!0),scene:e.get("scene"),field:e.get("field"),user:e.get("user")},this.el.sampleTile.classList.remove("d-none"),requestAnimationFrame(function(e){return t.firekey(e)}),document.addEventListener("keyup",function(e){var i,s;if(!(e.key<37||e.key>40))return i=t.user,s=e.which-37,i.dir===s?i.moving=!1:void 0}),document.addEventListener("keydown",function(e){var i,s;if(!(e.key<37||e.key>40))return i=t.user,s=e.which-37,i.dir===s&&i.moving||(i.lastMoveTime=null),i.dir=s,i.moving=!0,i})},zIndex:function(e){var t,i,s;return e.x,t=e.y,i=e.f,s=e.p,2*(i*this.dim.w*this.dim.h+t)+(s?1:0)},renderUser:function(){var e,t,i;return e=[stage.dim.size,stage.dim.vp],t=e[0],i=e[1],import$(this.el.user.style,{left:this.user.x*t+"px",top:this.user.y*t-this.user.f*i+"px",zIndex:this.zIndex({f:this.user.f,y:this.user.y,x:this.user.x,p:1})})},render:function(){var e,t,i,s,r,n,h,o,a,l,u,d,f,m,p,v,c,y,g,x,$;for(t=(e=[this.dim,this.tiles,stage.tileinfo])[0],i=e[1],s=e[2],r=(e=[stage.dim.size,stage.dim.vp])[0],n=e[1],h=(e=[this.el.sampleTile,this.el.field,this.el.scene])[0],o=e[1],import$(e[2].style,{width:t.w*r+"px",height:t.h*r+n*t.f+"px"}),o.innerHTML="",this.nodes=[],a=[],l=0,u=t.f;l<u;++l){for(d=l,f=[],m=0,p=t.h;m<p;++m){for(v=m,c=[],y=0,g=t.w;y<g;++y)x=y,$=h.cloneNode(!0),o.appendChild($),$.classList.add(s[i[d][v][x]].name),import$($.style,{left:x*r+"px",top:v*r-d*n+"px",zIndex:this.zIndex({f:d,x:x,y:v,p:0})}),c.push($);f.push(c)}a.push(f)}return this.nodes=a,this.renderUser()},load:function(arg$){var lv,this$=this;return lv=arg$.lv,ld$.fetch("/js/map/"+lv+".js",{},{type:"text"}).then(function(ret){return this$.data=eval(ret),this$.tiles=this$.data.tiles,import$(this$.user,this$.data.user),import$(this$.dim,{f:this$.data.tiles.length,h:this$.data.tiles[0].length,w:this$.data.tiles[0][0].length}),this$.render()})},transform:function(e){var t,i,s,r,n,h,o,a,l,u,d,f,m,p,v,c,y,g,x=[];for(t=e.src,i=e.des,r=(s=[this.tiles,this.nodes,stage.tileinfo,this.dim])[0],n=s[1],h=s[2],a=0,l=(o=s[3]).f;a<l;++a){for(u=a,d=[],f=0,m=o.h;f<m;++f){for(p=f,v=[],c=0,y=o.w;c<y;++c)g=c,r[u][p][g]===t&&(r[u][p][g]=i,n[u][p][g].classList.remove(h[t].name),v.push(n[u][p][g].classList.add(h[i].name)));d.push(v)}x.push(d)}return x}}),stage.prototype.firekey=function(e){var t,i,s,r,n,h,o,a,l,u,d,f,m,p,v,c,y,g,x,$,w,k,z,N,L,T,I=this;if(t=[stage.tileinfo,this.user,!0],i=t[0],s=t[1],r=t[2],t=[stage.dim.size,stage.dim.vp],n=t[0],h=t[1],requestAnimationFrame(function(e){return I.firekey(e)}),s.moving&&!(s.lastMoveTime&&e-s.lastMoveTime<100)&&(s.lastMoveTime=e,t=function(){switch(s.dir){case 0:return[-1,0];case 1:return[0,-1];case 2:return[1,0];case 3:return[0,1];default:return[NaN,NaN]}}(),o=t[0],a=t[1],!(isNaN(o)||(l=[{x:s.x,y:s.y},u={x:s.x+o,y:s.y+a},d={x:s.x+2*o,y:s.y+2*a}],f=[s.f-1,s.f,s.f+1],u.x<0||u.x>=this.dim.w||u.y<0||u.y>=this.dim.h||f[1]<0||f[1]>=this.dim.f)))){for(p=[],v=0;v<3;++v){for(c=v,y=[],g=0;g<3;++g)$=(t=[l[x=g].x,l[x].y,f[c]])[0],w=t[1],k=t[2],$<0||$>=this.dim.w||w<0||w>=this.dim.h||k<0||k>=this.dim.f?y.push(0):this.tiles[k]?y.push(this.tiles[k][w][$]):y.push(0);p.push(y)}if("e"===(m=p)[1][1]){if("a"!==(t=m[1][2])&&"f"!==t)return;z=(t=!i[m[0][2]]||i[m[0][2]].fill?[f[0],"c"]:[f[1],"e"])[0],N=t[1],this.tiles[f[1]][u.y][u.x]="a",this.tiles[z][d.y][d.x]=N,this.nodes[f[1]][u.y][u.x].classList.remove(i.e.name),this.nodes[f[1]][u.y][u.x].classList.add(i[N].name),import$(this.nodes[f[1]][u.y][u.x].style,{left:d.x*n+"px",top:d.y*n-z*h+"px",zIndex:this.zIndex({f:z,y:d.y,x:d.x,p:0})}),(L=this.nodes[z][d.y][d.x])&&L.parentNode.removeChild(L),this.nodes[z][d.y][d.x]=this.nodes[f[1]][u.y][u.x],this.nodes[f[1]][u.y][u.x]=null,r=!1}if("h"===m[1][1]&&(this.transform({src:"g",des:"i"}),this.user.item.push(7),this.tiles[f[1]][u.y][u.x]=0,(T=this.nodes[f[1]][u.y][u.x])&&T.parentNode&&T.parentNode.removeChild(T)),!r||!i[m[1][1]]||i[m[1][1]].through)return import$(s,u),this.renderUser()}},(s=new stage).init(),s.load({lv:1});